name: lego-hunter

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements.ai.txt

      - name: Run unit tests
        run: |
          python -m unittest discover -s tests -v

  scheduled-hunt:
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 25
    environment: lego_hunter
    if: ${{ github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements.ai.txt
          pip install -r requirements.playwright.txt
          python -m playwright install --with-deps chromium

      - name: Run scheduled discovery cycle
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GEMINI_FREE_TIER_ONLY: "true"
          OPENROUTER_FREE_TIER_ONLY: "true"
          DISCOVERY_SOURCE_MODE: external_first
          AI_RANK_MAX_CANDIDATES: "10"
          AI_SCORING_HARD_BUDGET_SEC: "75"
          AI_TIMEOUT_RECOVERY_PROBES: "2"
          AI_FAST_FAIL_ENABLED: "true"
          AI_BATCH_SCORING_ENABLED: "true"
          AI_BATCH_MIN_CANDIDATES: "2"
          AI_BATCH_MAX_CANDIDATES: "10"
          AI_SINGLE_CALL_SCORING_ENABLED: "true"
          AI_SINGLE_CALL_ALLOW_REPAIR_CALLS: "false"
          AI_SINGLE_CALL_MAX_CANDIDATES: "12"
          BOOTSTRAP_THRESHOLDS_ENABLED: "true"
          BOOTSTRAP_MIN_HISTORY_POINTS: "45"
          BOOTSTRAP_MIN_UPSIDE_PROBABILITY: "0.52"
          BOOTSTRAP_MIN_CONFIDENCE_SCORE: "50"
          OPENROUTER_JSON_REPAIR_PROBE_TIMEOUT_SEC: "4"
          RUN_MODE: scheduled
        run: |
          python bot.py --mode scheduled

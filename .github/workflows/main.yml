name: lego-hunter

on:
  workflow_dispatch:
    inputs:
      disable_ai_cache:
        description: "Disabilita cache AI per questa run (debug live scoring)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      analysis_set_id:
        description: "Set ID per analisi approfondita on-demand (es. 76441). Vuoto = ciclo standard."
        required: false
        default: ""
        type: string
      analysis_chat_id:
        description: "Chat Telegram destinazione per analisi on-demand. Vuoto = TELEGRAM_CHAT_ID secret."
        required: false
        default: ""
        type: string
  schedule:
    # GitHub cron is UTC; we schedule DST/CET candidate slots and gate by Europe/Rome hour.
    - cron: "0 6,7,19,20 * * *"

jobs:
  schedule-gate:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.decide.outputs.should_run }}
      local_hour: ${{ steps.decide.outputs.local_hour }}
    steps:
      - name: Decide schedule window (Europe/Rome)
        id: decide
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_run=true" >> "$GITHUB_OUTPUT"
            echo "local_hour=manual" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          local_hour="$(TZ=Europe/Rome date +%H)"
          if [ "$local_hour" = "08" ] || [ "$local_hour" = "21" ]; then
            echo "should_run=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_run=false" >> "$GITHUB_OUTPUT"
          fi
          echo "local_hour=$local_hour" >> "$GITHUB_OUTPUT"
      - name: Gate summary
        run: |
          echo "event=${{ github.event_name }}"
          echo "local_hour=${{ steps.decide.outputs.local_hour }}"
          echo "should_run=${{ steps.decide.outputs.should_run }}"

  test:
    needs: schedule-gate
    if: ${{ needs.schedule-gate.outputs.should_run == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements.ai.txt

      - name: Run unit tests
        run: |
          python -m unittest discover -s tests -v

  scheduled-hunt:
    runs-on: ubuntu-latest
    needs: [schedule-gate, test]
    timeout-minutes: 25
    environment: lego_hunter
    if: ${{ needs.schedule-gate.outputs.should_run == 'true' && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements.ai.txt
          pip install -r requirements.playwright.txt
          python -m playwright install --with-deps chromium

      - name: Sync secondary historical seed (eBay sold + Vinted active)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY != '' && secrets.SUPABASE_SERVICE_ROLE_KEY || secrets.SUPABASE_KEY }}
        continue-on-error: true
        run: |
          python scripts/sync_ebay_sold_history.py \
            --out data/historical_seed/ebay_reference_cases.csv \
            --markets IT \
            --include-eu-fallback \
            --include-vinted \
            --max-sets 120 \
            --max-vinted-targets 60 \
            --lookback-days 365 \
            --rolling-days 540 \
            --min-sold-listings 4 \
            --max-markets-per-set 1 \
            --min-vinted-listings 3 \
            --max-vinted-markets-per-set 1 \
            --persist-market-snapshots

      - name: Run scheduled discovery cycle
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY != '' && secrets.SUPABASE_SERVICE_ROLE_KEY || secrets.SUPABASE_KEY }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ github.event.inputs.analysis_chat_id != '' && github.event.inputs.analysis_chat_id || secrets.TELEGRAM_CHAT_ID }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GEMINI_FREE_TIER_ONLY: "true"
          OPENROUTER_FREE_TIER_ONLY: "true"
          DISCOVERY_SOURCE_MODE: external_first
          AI_RANK_MAX_CANDIDATES: "3"
          AI_SCORING_HARD_BUDGET_SEC: "90"
          AI_TIMEOUT_RECOVERY_PROBES: "2"
          AI_FAST_FAIL_ENABLED: "true"
          AI_BATCH_SCORING_ENABLED: "true"
          AI_BATCH_MIN_CANDIDATES: "2"
          AI_BATCH_MAX_CANDIDATES: "12"
          AI_SINGLE_CALL_SCORING_ENABLED: "true"
          AI_SINGLE_CALL_ALLOW_REPAIR_CALLS: "true"
          AI_SINGLE_CALL_MAX_CANDIDATES: "3"
          AI_SINGLE_CALL_BATCH_CHUNK_SIZE: "3"
          AI_SINGLE_CALL_BATCH_MAX_CALLS: "1"
          AI_SINGLE_CALL_DEGRADED_BATCH_CHUNK_SIZE: "3"
          AI_SINGLE_CALL_DEGRADED_BATCH_MAX_CALLS: "1"
          AI_SINGLE_CALL_MISSING_RESCUE_ENABLED: "false"
          AI_SINGLE_CALL_MISSING_RESCUE_MAX_CANDIDATES: "3"
          AI_SINGLE_CALL_MISSING_RESCUE_TIMEOUT_SEC: "10"
          AI_STRICT_FINAL_TOP_K_ONLY: "true"
          AI_STRICT_FINAL_TOP_K: "3"
          AI_NON_SHORTLIST_CACHE_RESCUE_ENABLED: "false"
          AI_SINGLE_CALL_SECONDARY_BATCH_ENABLED: "false"
          AI_PROBE_STRICT_REPROBE_ENABLED: "true"
          AI_PROBE_STRICT_MAX_CANDIDATES: "22"
          AI_PROBE_STRICT_BUDGET_SEC: "32"
          AI_PROBE_STRICT_TIMEOUT_SEC: "8"
          AI_PROBE_STRICT_EARLY_SUCCESSES: "1"
          AI_INSIGHT_CACHE_TTL_SEC: ${{ github.event.inputs.disable_ai_cache == 'true' && '0' || '86400' }}
          AI_PERSISTED_CACHE_TTL_SEC: ${{ github.event.inputs.disable_ai_cache == 'true' && '0' || '172800' }}
          AI_SCORE_GUARDRAIL_ENABLED: "true"
          AI_SCORE_SOFT_CAP: "95"
          AI_SCORE_SOFT_CAP_FACTOR: "0.35"
          AI_LOW_CONFIDENCE_SCORE_CAP: "90"
          AI_NON_JSON_SCORE_CAP: "85"
          AI_NON_JSON_TRUST_WEIGHT: "0.00"
          AI_NO_SIGNAL_MIN_STRICT_PASS_RATE: "0.55"
          AI_MODEL_QUALITY_MIN_TRUST_RATE: "0.60"
          AI_MODEL_QUALITY_MAX_NON_JSON_RATE: "0.20"
          AI_NON_JSON_CACHE_TTL_SEC: "7200"
          AI_NON_JSON_RESCORE_ENABLED: "false"
          AI_NON_JSON_RESCORE_MAX_CANDIDATES: "6"
          AI_NON_JSON_RESCORE_MIN_COMPOSITE: "62"
          BOOTSTRAP_THRESHOLDS_ENABLED: "true"
          BOOTSTRAP_MIN_HISTORY_POINTS: "45"
          BOOTSTRAP_MIN_UPSIDE_PROBABILITY: "0.56"
          BOOTSTRAP_MIN_CONFIDENCE_SCORE: "55"
          OPENROUTER_JSON_REPAIR_PROBE_TIMEOUT_SEC: "4"
          HISTORICAL_REFERENCE_CASES_PATH: "data/historical_seed/historical_reference_cases.csv,data/historical_seed/ebay_reference_cases.csv"
          HISTORICAL_ALLOWED_COUNTRIES: "IT"
          HISTORICAL_ALLOWED_REGIONS: "EU"
          HISTORICAL_INCLUDE_UNKNOWN_MARKET: "false"
          HISTORICAL_RECENCY_HALFLIFE_DAYS: "900"
          HISTORICAL_RECENCY_MIN_WEIGHT: "0.20"
          HISTORICAL_DEGRADED_MIN_PRIOR_SCORE: "35"
          SINGLE_SET_ANALYSIS_ID: ${{ github.event.inputs.analysis_set_id || '' }}
          RUN_MODE: scheduled
        run: |
          echo "AI cache debug mode: disable_ai_cache=${{ github.event.inputs.disable_ai_cache || 'false' }}"
          echo "On-demand set analysis: analysis_set_id='${{ github.event.inputs.analysis_set_id || '' }}'"
          echo "AI_INSIGHT_CACHE_TTL_SEC=${AI_INSIGHT_CACHE_TTL_SEC}"
          echo "AI_PERSISTED_CACHE_TTL_SEC=${AI_PERSISTED_CACHE_TTL_SEC}"
          python bot.py --mode scheduled
